{% extends "base.html" %}
{% load static %}

{% block title %}Transcript {{ tran_name }}{% endblock %}

{% block header %}
{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/table.css' %}">
    <link rel="stylesheet" href="{% static 'css/wider-container.css' %}">

    <style>
        .sticky-offset {
            top: 56px
        }

        .list-group > .list-group > .list-group-item {
            padding-left: 2.5rem;
        }

        .tab-content > .tab-pane:not(.active) {
            display: block;
            height: 0;
            overflow-y: hidden;
        }

        #protein-network {
            position: relative;
            height: 840px;
            border: 2px solid lightgray;
        }

        #domain-network {
            position: relative;
            height: 840px;
            border: 2px solid lightgray;
        }

        #interaction-network {
            position: relative;
            height: 600px;
            border: 2px solid lightgray;
        }

        img {
            max-width: 100%;
            max-height: 100%;
            display: block; /* remove extra space below image */
        }

        .tab {
            margin-left: 90px;
        }

        .tab {
            margin-left: 50px;
        }

        img {
            max-width: 100%;
            max-height: 100%;
        }

        img.resize {
            max-width: 80%;
            max-height: 80%;
        }

        img.resize2 {
            max-width: 55%;
            max-height: 55%;
        }
    </style>



    {#    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>#}

    <div class="wider-container">
        <div class="row">
            <!-- Vertical pill selection menu-->
            <div class="col-lg-3">
                {#                <h3 class="my-4">View selection</h3>#}
                <div class="nav flex-column nav-pills sticky-top sticky-offset" id="v-pills-tab" role="tablist"
                     aria-orientation="vertical">
                    <a class="nav-link active" id="v-pills-home-tab" data-toggle="pill" href="#v-pills-overview"
                       role="tab" aria-controls="v-pills-overview" aria-selected="true">Overview</a>

                    <a class="nav-link" id="v-pills-protein-tab" data-toggle="pill" href="#v-pills-protein" role="tab"
                       aria-controls="v-pills-protein" aria-selected="false">ProteinView</a>

                    <a class="nav-link" id="v-pills-interaction-tab" data-toggle="pill" href="#v-pills-interaction"
                       role="tab"
                       aria-controls="v-pills-compare" aria-selected="false">InteractionView</a>

                    {% if dis2 %}
                        <a class="nav-link" id="v-pills-domain-tab" data-toggle="pill" href="#v-pills-domain" role="tab"
                           aria-controls="v-pills-domain" aria-selected="false">DomainView</a>

                        <a class="nav-link" id="v-pills-compare-tab" data-toggle="pill" href="#v-pills-compare"
                           role="tab"
                           aria-controls="v-pills-interaction" aria-selected="false">Other isoforms</a>
                    {% endif %}

                </div>
            </div>
            <!-- /Vertical pill selection menu -->

            <!-- Page content -->
            <div class="col-lg-9">
                <!-- Jumbotron overview-->
                <div class="jumbotron p-xl-4">
                    <h1 class="display-4">Transcript {{ tran_name }}</h1>
                    <h5 class="lead"><span
                            style="font-weight:bold">Gene name</span>: {{ gene_description|safe }}
                    </h5>

                    <h5 class="lead">
                        <span style="font-weight:bold">Transcript name</span>: {{ tran_name|safe }}
                    </h5>

                    <h5 class="lead">
                        <span style="font-weight:bold">NCBI gene ID</span>: <a
                            href="https://www.ncbi.nlm.nih.gov/gene/{{ entrezID|safe }}"
                            target="_blank">{{ entrezID|safe }} </a>
                    </h5>

                    <h5 class="lead"><span style="font-weight:bold">Ensembl</span>: <a
                            href="https://www.ensembl.org/id/{{ gID|safe }}"
                            target="_blank"> {{ gID|safe }} </a>; <a
                            href="https://www.ensembl.org/id/{{ trID|safe }}"
                            target="_blank">{{ trID|safe }} </a>
                    </h5>
                </div>

                <!-- Tab content -->
                <div class="tab-content" id="v-pills-tabContent">
                    <!-- Overview content -->
                    <div class="tab-pane fade show active card" id="v-pills-overview" role="tabpanel"
                         aria-labelledby="v-pills-overview-tab">
                        <div class="card-body">
                            <p class="lead text-center"><span
                                    style="font-weight:bold">Domain and exon architecture </span></p>

                            <img src="{% get_media_prefix %}images/{{ trID }}.png">
                            <img class="resize2 text-center mt-2 img-fluid" src="{% static 'image/legend 3.png' %}">

                            <!-- Exon Table-->
                            <h6 class="mt-5">
                                <h5 class="mb-3">{{ text1 }}</h5>
                                {% autoescape off %}
                                    {{ dt }}
                                {% endautoescape %}
                            </h6>
                        </div>
                    </div>


                    <!-- ProteinView content -->
                    <div class="tab-pane fade card" id="v-pills-protein" role="tabpanel"
                         aria-labelledby="v-pills-protein-tab">

                        <h2 class="card-header"> ProteinView </h2>
                        <div class="card-body">

                            {% if enable_Proteinview %}
                                <h5 class="tab1"> ProteinView is not available for this protein because of its high
                                    number of partners in the PPI. Please check InteractionView or DomainView.</h5>
                            {% endif %}

                            {% if not enable_Proteinview %}

                                <h5 class="tab1"> ProteinView provides a general visualization of the protein and its
                                    domains interactions. Please select your view mode:</h5>
                                <br>

                                <h6 class="tab"><span style="font-weight:bold">PPI View</span>: show only protein
                                    interactions. Nodes are proteins and the central node is the selected transcript.
                                </h6>
                                <h6 class="tab"><span style="font-weight:bold">PPI-DDI View</span>: proteins are shown
                                    together with their domains and domains-domains interactions. </h6>
                                <br>

                                <h6 class="tab1"> You can move the protein and domain nodes as you wish for a better
                                    view.
                                    Notice that the generated network in this view can be very big or difficult to
                                    visualize. In that case, DomainView or InteractionView can provide better
                                    visualization. </h6>
                                <br>
                                <hr>
                                <!-- View options -->
                                <h5>
                                    <div class="form-group row">
                                        <label for="nodeFilterSelect" class="col-sm-2 col-form-label">View Mode</label>
                                        <div class="col-sm-10">
                                            <select id="nodeFilterSelect" class="form-control">
                                                <option value="PPI"> PPI View</option>
                                                <option value="PPI-DDI"> PPI-DDI View</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-2">Physics</div>
                                        <div class="col-sm-10">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input"
                                                       id="physicsSwitchProtein"
                                                       name="physics-checkbox-protein" checked>
                                                <label class="custom-control-label" for="physicsSwitchProtein">Enable
                                                    physics</label>
                                            </div>
                                        </div>
                                    </div>
                                </h5>

                                <center>
                                    <div id="protein-network"></div>
                                    <script type="text/javascript">

                                        var PR_LENGTH = 500,
                                            LENGTH_domain = 20,
                                            PR_DM = 400,
                                            LENGTH_SUB = 50,
                                            WIDTH_SCALE = 2,
                                            GREEN = "green",
                                            RED = "#C5000B",
                                            //ORANGE = "orange",
                                            YELLOW = "orange",
                                            WHITE = "EED5EB"
                                        //GRAY = '#666666',
                                        GRAY = "gray",
                                            BLACK = "#2B1B17";
                                        missing = '#C70039';
                                        Residue = '#DA70D6';
                                        // create an array with nodes
                                        var nodes = new vis.DataSet([

                                            {% for node in pv_nodes %}
                                                {{ node|safe }}
                                            {% endfor %}



                                        ]);
                                        // create an array with edges
                                        var edges = new vis.DataSet([

                                            {% for edge in pv_edges %}
                                                {{ edge|safe }}
                                            {% endfor %}

                                        ]);


                                        const nodeFilterSelector = document.getElementById("nodeFilterSelect");


                                        // create a network
                                        var container = document.getElementById('protein-network');
                                        var data = {
                                            nodes: nodes,
                                            edges: edges
                                        };


                                        var options = {


                                            interaction: {
                                                navigationButtons: true,

                                            },
                                            physics: {
                                                enabled: true,
                                                barnesHut: {gravitationalConstant: -10000},
                                                stabilization: {iterations: 20},
                                            },


                                            nodes: {
                                                scaling: {
                                                    min: 16,
                                                    max: 32
                                                }
                                            },
                                            edges: {
                                                color: WHITE,
                                                smooth: false,

                                            },


                                            groups: {
                                                protein: {
                                                    shape: "dot",
                                                    color: GRAY, // orange
                                                    font:
                                                        {
                                                            size: 18, // px
                                                        }
                                                },


                                                domain: {
                                                    shape: "triangle",
                                                    color: "#2B7CE9" // blue
                                                },


                                                transcript: {
                                                    shape: "square",
                                                    color: "#109618" // green
                                                }
                                            }
                                        };


                                        let nodeFilterValue = "";


                                        const nodesFilter = node => {
                                            if (nodeFilterValue === "") {
                                                return node.group === "protein";
                                            }
                                            switch (nodeFilterValue) {

                                                case "PPI-DDI":
                                                    return node.source === "DDI";

                                                case "PPI":
                                                    return node.group === "protein";

                                                default:
                                                    return true;
                                            }
                                        };


                                        const nodesView = new vis.DataView(nodes, {filter: nodesFilter});


                                        nodeFilterSelector.addEventListener("change", e => {
                                            // set new value to filter variable
                                            nodeFilterValue = e.target.value;
                                            /*
                                                  refresh DataView,
                                                  so that its filter function is re-calculated with the new variable
                                                */
                                            nodesView.refresh();


                                        });


                                        var checkbox = document.querySelector("input[name=physics-checkbox-protein]");

                                        function startNetwork(data) {

                                            var network = new vis.Network(container, data, options);


                                            checkbox.addEventListener('change', function () {
                                                if (this.checked) {
                                                    network.setOptions({physics: true});
                                                } else {
                                                    network.setOptions({physics: false});

                                                }
                                            });


                                            nodeFilterSelector.addEventListener("change", e => {

                                                network.setOptions({physics: true});
                                                if (document.getElementById('checkbox').checked) {

                                                    setTimeout(function () {
                                                        network.setOptions({physics: false});
                                                    }, 5000);

                                                    network.fit();
                                                }

                                            });


                                        }


                                        startNetwork({nodes: nodesView, edges: edges});


                                    </script>
                                    <img class="resize" src="{% static 'image/legend1.png' %}" alt="">
                                </center>

                                {% if dis1 %}
                                    <h6 class="tab1"> Dashed edges represent missing domains in the selected protein
                                        ({{ tran_name|safe }}) but present in other isoforms. These domain-domain
                                        interactions are missing, which may also affect the interactions with their
                                        respective proteins. </h6>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>


                    <!-- DomainView content -->
                    <div class="tab-pane fade card" id="v-pills-domain" role="tabpanel"
                         aria-labelledby="v-pills-domain-tab">

                        <h2 class="card-header"> DomainView </h2>
                        <div class="card-body">
                            <h5 class="tab1"> DomainView provides a more specific graphical visualization for each
                                domain. The domain is shown only once, and all proteins containing the domain are linked
                                to this domain node. </h5>
                            <hr>

                            <!-- View options -->
                            <h5>
                                <div class="form-group row">
                                    <label for="nodeFilterSelect2" class="col-sm-2 col-form-label">Pfam domain
                                        ID</label>
                                    <div class="col-sm-10">
                                        <select id="nodeFilterSelect2" class="form-control">
                                            <optgroup label="Domains of the isoform">
                                                {% for s in switch1 %}
                                                    {{ s|safe }}
                                                {% endfor %}
                                            </optgroup>
                                            {% if dis1 %}
                                                <optgroup label="Domains missing in the isoform">
                                                    {% for s in switch1_missing %}
                                                        {{ s|safe }}
                                                    {% endfor %}
                                                </optgroup>
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-sm-2">Physics</div>
                                    <div class="col-sm-10">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="physicsSwitchDomain"
                                                   name="physics-checkbox-domain" checked>
                                            <label class="custom-control-label" for="physicsSwitchDomain">Enable
                                                physics</label>
                                        </div>
                                    </div>
                                </div>
                            </h5>

                            <!-- Vis.js Network-->
                            <div id="domain-network"></div>
                            <script type="text/javascript">
                                var L1 = 300,
                                    L2 = 30,
                                    PR_DM = 400,
                                    LENGTH_SUB = 50,
                                    WIDTH_SCALE = 2,
                                    GREEN = "green",
                                    RED = "#C5000B",
                                    //ORANGE = "orange",
                                    YELLOW = "orange",
                                    WHITE = "EED5EB"
                                //GRAY = '#666666',
                                GRAY = "gray",
                                    BLACK = "#2B1B17";


                                // create an array with nodes
                                var nodes2 = new vis.DataSet([

                                    {% for node in Domainview_nodes %}
                                        {{  node|safe }}
                                    {% endfor %}

                                ]);
                                // create an array with edges
                                var edges2 = new vis.DataSet([

                                    {% for edge in Domainview_edges %}
                                        {{ edge|safe }}
                                    {% endfor %}
                                ]);


                                const nodeFilterSelector2 = document.getElementById("nodeFilterSelect2");


                                // create a network
                                var container2 = document.getElementById('domain-network');
                                var data2 = {
                                    nodes2: nodes2,
                                    edges2: edges2
                                };


                                var options2 = {


                                    interaction: {
                                        navigationButtons: true,

                                    },

                                    physics: {
                                        barnesHut: {gravitationalConstant: -10000},
                                        stabilization: {iterations: 15},

                                    },

                                    nodes: {
                                        scaling: {
                                            min: 16,
                                            max: 32
                                        }
                                    },
                                    edges: {
                                        color: WHITE,
                                        smooth: false,

                                    },


                                    groups: {
                                        protein: {
                                            shape: "dot",
                                            color: GRAY, // orange
                                            font:
                                                {
                                                    size: 18, // px
                                                }
                                        },


                                        Domain: {
                                            shape: "triangle",
                                            color: "#2B7CE9" // blue
                                        },


                                        MDomain: {
                                            shape: "triangle",
                                            color: "#109618" // green
                                        }
                                    }
                                };


                                var checkbox2 = document.querySelector("input[name=physics-checkbox-domain]");


                                function startNetwork(data2) {

                                    var network2 = new vis.Network(container2, data2, options2);

                                    checkbox2.addEventListener('change', function () {
                                        if (this.checked) {
                                            network2.setOptions({physics: true});
                                        } else {
                                            network2.setOptions({physics: false});

                                        }
                                    });


                                    nodeFilterSelector2.addEventListener("change", e => {

                                        network2.setOptions({physics: true});
                                        if (document.getElementById('checkbox2').checked) {

                                            setTimeout(function () {
                                                network2.setOptions({physics: false});
                                            }, 10000);


                                        }

                                    });

                                    network2.fit();
                                };


                                let nodeFilterValue2 = "";


                                const nodesFilter2 = node => {
                                    if (nodeFilterValue2 === "") {
                                        return node.source === "{{ first_domain|safe}}";
                                    }
                                    switch (nodeFilterValue2) {

                                        {% for s in switch2 %}
                                            {{ s|safe }}
                                        {% endfor %}

                                        default:
                                            return true;
                                    }
                                };


                                const nodesView2 = new vis.DataView(nodes2, {filter: nodesFilter2});


                                nodeFilterSelector2.addEventListener("change", e => {
                                    // set new value to filter variable
                                    nodeFilterValue2 = e.target.value;
                                    /*
                                          refresh DataView,
                                          so that its filter function is re-calculated with the new variable
                                        */
                                    nodesView2.refresh();


                                });


                                startNetwork({nodes: nodesView2, edges: edges2});


                            </script>

                            <!-- Tables-->
                            <div style="text-align: center;" class="mt-5">
                                <h4 class="lead">Domains of the isoform {{ tran_name }}</h4>
                            </div>
                            <h6 class="mt-3">
                                {% autoescape off %}
                                    {{ dt2 }}
                                {% endautoescape %}
                            </h6>


                            {% if dis1 %}
                                <div style="text-align: center;" class="mt-5">
                                    <h4 class="lead"> Domains missing in the transcript but present in other
                                        isoforms.</h4>
                                    <h6 class="mt-3">
                                        {% autoescape off %}
                                            {{ dt3 }}
                                        {% endautoescape %}
                                    </h6>
                                </div>
                            {% endif %}
                        </div>
                    </div>


                    <!-- InteractionView content -->
                    <div class="tab-pane fade card" id="v-pills-interaction" role="tabpanel"
                         aria-labelledby="v-pills-interaction-tab">

                        <h2 class="card-header"> InteractionView </h2>
                        <div class="card-body">

                            {% if dis2 %}
                                <h5> InteractionView provides an interactive visualization of isoform-specific
                                    interactions. The interactions in the table are confirmed by both Protein-Protein
                                    Interactions (PPI) and Domain-Domain Interactions (DDI) networks. If residue-level
                                    evidence is available a <span>&#9733;</span>is shown in the table. </h5>
                                <br/>
                                <h5> You can select the protein partner to visualize it individually and download the
                                    isoform interactions table.</h5>
                                <br/>

                                <h6 class="tab1" style="text-align: left;"><span>&#9733;</span> An interaction with
                                    residue-level evidence. </h6>

                                <hr>
                                <!-- View options -->
                                <h5>
                                    <div class="form-group row">
                                        <label for="inputEmail3" class="col-sm-2 col-form-label">Interaction</label>
                                        <div class="col-sm-10">
                                            <select id="nodeFilterSelect3" class="form-control">
                                                {% for s in Interactiveview_selec %}
                                                    {{ s|safe }}
                                                {% endfor %}

                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group row">
                                        <div class="col-sm-2">Physics</div>
                                        <div class="col-sm-10">
                                            <div class="custom-control custom-switch">
                                                <input type="checkbox" class="custom-control-input"
                                                       id="physicsSwitchInteraction"
                                                       name="physics-checkbox-interaction" checked>
                                                <label class="custom-control-label" for="physicsSwitchInteraction">Enable
                                                    physics</label>
                                            </div>
                                        </div>
                                    </div>
                                </h5>

                                <div style="text-align: center;">
                                    <div id="interaction-network"></div>

                                    <script type="text/javascript">

                                        var PR_LENGTH = 500,
                                            LENGTH_domain = 20,
                                            PR_DM = 400,
                                            LENGTH_SUB = 50,
                                            WIDTH_SCALE = 2,
                                            GREEN = "green",
                                            RED = "#C5000B",
                                            //ORANGE = "orange",
                                            YELLOW = "orange",
                                            WHITE = "EED5EB"
                                        //GRAY = '#666666',
                                        GRAY = "gray",
                                            BLACK = "#2B1B17";
                                        missing = '#C70039';
                                        Residue = '#DA70D6';


                                        var nodes3 = new vis.DataSet([

                                            {% for node in pv_nodes %}
                                                {{ node|safe }}
                                            {% endfor %}



                                        ]);
                                        // create an array with edges
                                        var edges3 = new vis.DataSet([

                                            {% for edge in pv_edges %}
                                                {{ edge|safe }}
                                            {% endfor %}

                                        ]);


                                        const nodeFilterSelector3 = document.getElementById("nodeFilterSelect3");


                                        // create a network
                                        var container3 = document.getElementById('interaction-network');
                                        var data3 = {
                                            nodes3: nodes3,
                                            edges3: edges3
                                        };


                                        var options3 = {


                                            interaction: {
                                                navigationButtons: true,

                                            },
                                            physics: {
                                                enabled: true,
                                                barnesHut: {gravitationalConstant: -10000},
                                                stabilization: {iterations: 20},
                                            },


                                            nodes: {
                                                scaling: {
                                                    min: 16,
                                                    max: 32
                                                }
                                            },
                                            edges: {
                                                color: WHITE,
                                                smooth: false,

                                            },


                                            groups: {
                                                protein: {
                                                    shape: "dot",
                                                    color: GRAY, // orange
                                                    font:
                                                        {
                                                            size: 18, // px
                                                        }
                                                },


                                                domain: {
                                                    shape: "triangle",
                                                    color: "#2B7CE9" // blue
                                                },


                                                transcript: {
                                                    shape: "square",
                                                    color: "#109618" // green
                                                }
                                            }
                                        };


                                        let nodeFilterValue3 = "";


                                        const nodesFilter3 = node => {
                                            if (nodeFilterValue3 === "") {
                                                return (node.id === "{{ entrezID|safe }}") || (node.id === "{{ first_vict|safe }}") || (node.origin === "{{ first_vict|safe }}") || (node.origin === "{{ entrezID|safe }}");
                                            }
                                            switch (nodeFilterValue3) {

                                                {% for s in Interactiveview_switch %}
                                                    {{ s|safe }}
                                                {% endfor %}



                                                default:
                                                    return true;
                                            }
                                        };


                                        const nodesView3 = new vis.DataView(nodes3, {filter: nodesFilter3});


                                        nodeFilterSelector3.addEventListener("change", e => {
                                            // set new value to filter variable
                                            nodeFilterValue3 = e.target.value;
                                            /*
                                                  refresh DataView,
                                                  so that its filter function is re-calculated with the new variable
                                                */
                                            nodesView3.refresh();


                                        });

                                        var checkbox3 = document.querySelector("input[name=physics-checkbox-interaction]");

                                        function startNetwork(data3) {

                                            var network3 = new vis.Network(container3, data3, options3);

                                            network3.fit()

                                            checkbox3.addEventListener('change', function () {
                                                if (this.checked) {
                                                    network3.setOptions({physics: true});
                                                } else {
                                                    network3.setOptions({physics: false});
                                                    network3.fit()
                                                }
                                            });


                                            nodeFilterSelector3.addEventListener("change", e => {

                                                network3.setOptions({physics: true});
                                                if (document.getElementById('checkbox').checked) {

                                                    setTimeout(function () {
                                                        network3.setOptions({physics: false});
                                                    }, 2500);
                                                    network3.fit()

                                                }

                                            });


                                        }


                                        startNetwork({nodes: nodesView3, edges: edges3});


                                    </script>
                                    <img class="resize" src="{% static 'image/legend1.png' %}" alt="">
                                </div>

                                <div style="text-align: center;" class="mt-5">
                                    <h4 class="lead"> Protein partners of the isoform {{ tran_name|safe }}  </h4>
                                    <h6 class="my-3">
                                        {% autoescape off %}
                                            {{ dt4 }}
                                        {% endautoescape %}
                                    </h6>
                                </div>

                                <h6 class="tab1" style="text-align: left;"><span
                                        style="font-weight:bold">Retained DDIs</span>:
                                    For every partner, a list of the retained DDI in this protein variant is shown.
                                </h6>
                                <h6 class="tab1" style="text-align: left;"><span
                                        style="font-weight:bold">Missing DDIs</span>: The interactions missing from the
                                    selected protein but present in other isoforms. You can check other variants of this
                                    gene 'Other isoforms' section. </h6>

                                <div style="text-align: center;" class="mt-4">
                                    <a href="{% get_media_prefix %}/table 2/{{ trID|safe }}.csv"
                                       class="btn btn-secondary px-4 py-2 btn-sm">Download table as CSV</a>
                                </div>

                            {% else %}
                                <h5 class="tab1" style="text-align: left;"> The protein doesn't have any interaction
                                    confirmed
                                    by both PPI and DDI networks.</h5>
                            {% endif %}
                        </div>
                    </div>


                    <!-- Compare with other isoforms content -->
                    <div class="tab-pane fade card" id="v-pills-compare" role="tabpanel"
                         aria-labelledby="v-pills-compare-tab">

                        {% if dis2 %}

                            <h2 class="card-header">Compare with other isoforms</h2>
                            <div class="card-body">
                                <h5 class="tab1" style="text-align: left;"></h5>
                                <div style="text-align: center;">
                                    <h4 class="lead"> List of isoforms </h4>
                                    <h6 class="mt-3">
                                        {% autoescape off %}
                                            {{ dt5 }}
                                        {% endautoescape %}
                                    </h6>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                </div>
                <!-- /Page content -->
            </div>
        </div>
    </div>
{% endblock %}